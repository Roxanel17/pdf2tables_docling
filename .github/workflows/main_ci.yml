# This workflow will install Python dependencies, run tests and lint with a single version of Python
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-python

name: PDF Pipeline

on:
  # push:
  #   branches:
  #     - main
  #     - dev-test
  # pull_request:
  #   branches:
  #     - main
  #     - dev-test

  workflow_dispatch:
    inputs:
      pdf_path:
        description: "Path to PDF (relative to repo)"
        required: true
        default: "input_pdf/BRD_IFRS_December_2024_EN.pdf"
      pages:
        description: "Pages or ranges, e.g. '71-75' or '71-75 90'"
        required: false
        default: ""
      output_prefix:
        description: "Prefix for output files"
        required: false
        default: "ci_run"

jobs:
  run-docling:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v6
        with:
          version: "latest"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: uv sync

      - name: Run Docling extraction
        run: |
          PDF_PATH="${{ github.event.inputs.pdf_path || 'input_pdf/BRD_IFRS_December_2024_EN.pdf' }}"
          PAGES="${{ github.event.inputs.pages }}"
          PREFIX="${{ github.event.inputs.output_prefix || 'ci_run' }}"

          echo "PDF Path: $PDF_PATH"
          echo "Pages: $PAGES"
          echo "Output Prefix: $PREFIX"

          if [ -z "$PAGES" ]; then
            uv run python scripts/docling_pages_to_md.py "$PDF_PATH" --output-prefix "$PREFIX"
          else
            uv run python scripts/docling_pages_to_md.py "$PDF_PATH" --pages $PAGES --output-prefix "$PREFIX"
          fi

      - name: Convert markdown to Excel
        run: |
          PREFIX="${{ github.event.inputs.output_prefix || 'ci_run' }}"
          MD_FILE="outputs/outputs_md/${PREFIX}_pages.md"

          echo "Looking for markdown file: $MD_FILE"

          if [ ! -f "$MD_FILE" ]; then
            MD_FILE="outputs/outputs_md/${PREFIX}.md"
          fi

          echo "Converting markdown to Excel from: $MD_FILE"

          uv run python scripts/save_output_excel.py "$MD_FILE" --output-name "${PREFIX}_tables.xlsx"

      - name: Upload markdown outputs
        uses: actions/upload-artifact@v4
        with:
          name: markdown_outputs
          path: outputs/outputs_md/
          if-no-files-found: ignore

      - name: Upload Excel outputs
        uses: actions/upload-artifact@v4
        with:
          name: excel_outputs
          path: outputs/outputs_excel/
          if-no-files-found: ignore
