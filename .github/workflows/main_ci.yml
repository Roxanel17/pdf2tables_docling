# This workflow will install Python dependencies, run tests and lint with a single version of Python
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-python

name: PDF Pipeline

on:
  # still run on push if you want
  # push:
  #   branches: [ main, dev-test ]
  # pull_request:
  #   branches: [ main, dev-test ]

  # ðŸ‘‰ manual trigger with arguments
  workflow_dispatch:
    inputs:
      pdf_path:
        description: "Path to PDF (relative to repo)"
        required: true
        default: "input_pdf/BRD_IFRS_December 2024 EN.pdf"
      pages:
        description: "Pages or ranges, e.g. '71-75' or '71-75 90'"
        required: false
        default: ""
      output_prefix:
        description: "Output prefix for generated files"
        required: false
        default: "ci_run"

jobs:
  run-docling:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v6
        with:
          version: "latest"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies with uv
        run: uv sync

      - name: Run docling_pages_to_md
        run: |
          PDF_PATH="${{ github.event.inputs.pdf_path || 'input_pdf/BRD_IFRS_December 2024 EN.pdf' }}"
          PAGES="${{ github.event.inputs.pages }}"
          PREFIX="${{ github.event.inputs.output_prefix || 'ci_run' }}"

          echo "Using PDF: $PDF_PATH"
          echo "Pages: '$PAGES'"
          echo "Output prefix: $PREFIX"

          if [ -z "$PAGES" ]; then
            # no pages provided â†’ full document
            uv run python scripts/docling_pages_to_md.py "$PDF_PATH" --output-prefix "$PREFIX"
          else
            # pages provided â†’ forward them as-is
            uv run python scripts/docling_pages_to_md.py "$PDF_PATH" --pages $PAGES --output-prefix "$PREFIX"
          fi

      - name: Upload markdown outputs
        uses: actions/upload-artifact@v4
        with:
          name: markdown_outputs
          path: outputs/outputs_md/
          if-no-files-found: ignore
